name: Prepare Blog Content

on:
  workflow_dispatch:
  schedule:
    - cron: "10 3 * * *"   # täglicher Rebuild

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout blog repo
        uses: actions/checkout@v4

      - name: Checkout vault repo
        uses: actions/checkout@v4
        with:
          repository: tuxpeople/obsidian-blog-source
          path: vault
          token: ${{ secrets.SOURCE_TOKEN }}   # falls privat

      - name: Install obsidian-export
        run: |
          curl --proto '=https' --tlsv1.2 -LsSf https://github.com/zoni/obsidian-export/releases/download/v25.3.0/obsidian-export-installer.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          obsidian-export --version

      - name: Export blog posts + assets
        run: |
          rm -rf _posts assets/images
          mkdir -p _posts assets/images
          obsidian-export "vault/Blog/ready" _posts
          find _posts -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" -o -iname "*.svg" \) -exec mv {} assets/images/ \;
          for file in _posts/*.md; do
            sed -i 's#](assets/#](/assets/images/#g' "$file"
          done

      - name: Ensure Jekyll filenames
        run: |
          for f in _posts/*.md; do
            base="$(basename "$f" .md)"
            if [[ ! "$base" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}- ]]; then
              d="$(grep -m1 '^date:' "$f" | sed 's/^date:[[:space:]]*//')"
              # ISO-Datum extrahieren; fallback: heute
              datepart="$(date -d "$d" +%F 2>/dev/null || date +%F)"
              title="${base}"
              # slugify rudimentär
              title="$(echo "$title" | sed -e 's/[Ää]/ae/g' -e 's/[Öö]/oe/g' -e 's/[Üü]/ue/g' -e 's/ß/ss/g' \
                                           -e 's/[^A-Za-z0-9 -]//g' -e 's/[[:space:]]\+/-/g' -e 's/-\+/-/g' | tr A-Z a-z)"
              mv "$f" "_posts/${datepart}-${title}.md"
            fi
          done

      - name: Commit & Push changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add _posts assets/images
          git commit -m "Update blog content" || echo "No changes"
          git push
